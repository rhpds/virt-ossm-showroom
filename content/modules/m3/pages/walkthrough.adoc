# Module 3: Enhancing Networking with OpenShift Service Mesh (OSSM)

## Task 1: Access the Observability Stack

The first feature of Service Mesh you will explore is the ability to enhance mesh included applications with added observability amd without the need for the applications within the Virtual Machines to be altered. 

Lets find the URLs of the observability components by executing the following commands in your terminal.

[,sh,subs="attributes",role=execute]
----
echo "http://$(oc get route kiali -o jsonpath='{.spec.host}' -n istio-system)"
echo "https://$(oc get route jaeger -o jsonpath='{.spec.host}' -n istio-system)"
echo "https://$(oc get route grafana -o jsonpath='{.spec.host}' -n istio-system)"
----

NOTE: The service mesh components have been installed by the platform team in the `istio-system` namespace. Alternatively, you can go to project `istio-system` in the OpenShift console and find the observability URLS at the *Networking -> Routes* menu from the left.

. First Login to the `Jaeger` dashboard to check the traffic traces for the _Travel Agency_ solution:
+
image::02-jaeger-login.gif[]
+
* Open the link to the Jaeger URL (*Login with OpenShift* using the credentials (*${openshift_cluster_admin_username}/${openshift_cluster_admin_password}*). At  `Authorize Access` page select `Allow selected permissions`).
* The `Jaeger` dashboard shows traces captured by the mesh of the traffic flowing between components that are part of the mesh. Whilst the `Service` drop down list offers to select the service that traffic is originating 
* Currently, you should see there are no services listed. *Challenge: Can you figure out based on the information provided in Task 1 why that is?*
+
image::03-t2-jaeger-empty.png[]
* Leave the `Jaeger` dahsboard open in your browser as we will come back to it a little later and lets explore the next observability tool.

. Lets now access the `Grafana` dashboard:
* Follow the link to the `Grafana` URL login with *${openshift_cluster_admin_username}/${openshift_cluster_admin_password}*.
* From the left menu follow *Dashboards → Browse → Istio → Istio Mesh Dashboard* to access the `Grafana`` dashboard that shows the services in the mesh, traffic volume towards them as well as HTTP codes of sucess failure of the requests.
* You should see again there are no services listed or traffic flowing. *You must be suspecting something is not quite right by now. Can you point your finger where the problem is?*
+
image::04-t2-grafana-empty.png[]

* Service Mesh has precreated a few dashboards under *Dashboards → Browse → Istio* to monitoring of both the dataplane (Virtual Machines, containers) as well as controlplane (the istio components) of the mesh.
* Leave the `Grafana` dahsboard open in your browser as we will come back to it a little later and lets explore `Kiali`.


. Login to `Kiali` to view a visualisation of the _Travel Agency_ solution in the mesh:
* Follow the link to the `Kiali` URL, login with *${openshift_cluster_admin_username}/${openshift_cluster_admin_password}* and 
* Fom the left hand side menu select _Graph_ and from the _Namespace_ drop-down menu (top) choose the `Select All` option.
* Notice, again there is no Graph visualisation of any service _Travel Agency_ solution:
+
image::05-t2-kiali-empty.png[]

* Leave the 'Kiali' dahsboard in your browser and proceed to the next task.

IMPORTANT: Why can I not see my services?

You have now been successful accessing and exploring the additional observability tools delivered by service mesh you would not get from the default OpenShift observability stack.  


## Task 2: Add the _Travel Agency_ Virtual Machines & Containers to the mesh

IMPORTANT: If it was not apparent until now, service mesh is capable of applying policies (security, observability etc.) only to Virtual Machines and containers that are part of the mesh. In order to enable the Travel Agency to become part of the mesh each namespace must be configured to be member of the mesh and each component needs to have an additional _sidecar container_ which will intercept the calls to/from your Virtual Machine. Right now though the Virtual Machines look like the have a single container:

image::06-t2-ossm-travel-agency-1-container.png[]
image::06-t2-ossm-travel-control-1-container.png[]


Lets add the _Travel Agency_ solution to the service mesh. First create a `ServiceMeshMember` resource (see the resources at https://github.com/rhpds/virt-ossm-workspace/blob/main/lab-3/servicemeshmember.yaml[servicemeshmember.yaml]) for each of the 3 namespaces of _Travel Agency_ which will include them to the mesh.

[,sh,subs="attributes",role=execute]
----
oc apply -f servicemeshmember.yaml
----

Following that, add an `envoy` (namely the `istio-proxy` container) to each `POD` of the _Travel Agency_.

* The following actions insert the annotation `sidecar.istio.io/inject` in each `POD` and restarts them so that service mesh injects the `istio-proxy` container and starts applying the policies. For details of each action see the scripts at https://github.com/rhpds/virt-ossm-workspace/blob/main/lab-3/add-envoy-to-travel-agency-services-domain.sh[add-envoy-to-travel-agency-services-domain.sh], https://github.com/rhpds/virt-ossm-workspace/blob/main/lab-3/add-envoy-to-travel-portal-domain.sh[add-envoy-to-travel-portal-domain.sh], https://github.com/rhpds/virt-ossm-workspace/blob/main/lab-3/add-envoy-to-travel-control.sh[add-envoy-to-travel-control.sh]

[,sh,subs="attributes",role=execute]
----
./add-envoy-to-travel-agency-services-domain.sh
./add-envoy-to-travel-portal-domain.sh
./add-envoy-to-travel-control.sh
----

* Now all _Travel Agency_ VM and Container components are in the mesh with 2 containers in each POD, with `istio-proxy` intercepting incoming/outgoing calls and applying mesh policeis:
+
image::06-2-containers.gif[]


*This is it!!* The Virtual Machiness now can take advantage of all the default service mesh features.


## Task 3: Validate that the _Travel Agency_ Virtual Machines are part of the mesh

Back in the `Kiali` screen we are now able to visualise information about the mesh included _Travel Agency_. 

IMPORTANT: However, `Kiali` will give you a lot more than just visualisation of the network, you can review the applied mesh configurations, modify them and apply new ones. Lets see what further information you can extract with it.

With the *Select All* option, from the *Select Namespace* drop-down menu (at the top), you should now see the 3 _Travel Agency_ namespaces listed. The `Versioned App Graph` should result in the whole network of microservices (VMs and containers) being displayed and interacting (the VMs in `travel-agency`,  `travel-control` namespaces side-by-side with the container based deployments in `travel-portal`).

image::06-t2-ossm-travel-agency.gif[]

*Fantastic!!* `Kiali` has just made the whole network of the _Travel Agency_ containers and VMs visible and you only had to make 1 annotation change to the Virtual Machine Deployment.

NOTE: You can carry on viewing the network in real-time however `Kiali` also has *Replay* features and you can find the replay icon image:07-t2-kiali-replay.png[] next to the *Last 1 minute* (the default duration of the network display period). Explore the additional ability these features give you to look at the state of the network at an earlier time selecting different options.

Firstly, explore the default _security_ configurations the mesh has already applied. In the *Graph* go to the *Display (drop down) -> Security*. This reveals through the *lock icon* that all communications have now been encrypted via a mesh generated and rotated certificate. Click on the line connecting the *travels v1* service to *travels vm* and notice on the right hand-side menu under *mTLS Enabled* it shows the principals in the _spiffe_ certificates exchanged. *Just like that* we have ensured no man in the middle loophole!!

Furthermore, the *Display* menu gives you the ability to visualise the *% of Traffic Distribution*, *Throughput request/response*, *Response Time (by percentile)*. Go ahead and use these options to explore the information as the following animated guide also shows.

image::07-t2-kiali-graph-validation.gif[]

It is obvious now that the mesh is by default also capturing network metrics of the solution, lets  use it to check more details on the _throughput size_ and _latency_ in/out of the *travels-vm* Virtual Machine. Go to *Workloads -> travels-vm -> Inbound Metrics* and increase the time metrics are shown for from the top right drop-down menu from the default *Last 1 minute* to *1 hour* (Note: you don't have 1 hours of metrics but slowly this graph will fill up), select from the *Reported from* drop down *Source* and tick the *Tredline* option. You are able now to hover and explore per service in the `travel-portal` namespace the throughput and duration of requests towards *travels-vm*. Change to the *Outbound Metrics* tab and perform the same review for the services called by *travels vm* (the animated guide below shows the pages retrieved through these actions). The *Tredline* will help to understand if things are going up or down.

image::08-t2-kiali-metrics.gif[]

Finally, as we said earlier `Kiali` enables the operator to also manage mesh configurations. Go to *Istio Config -> Namespace (drop down) -> Select all travel-xxx namespaces*. You should see there are no custom added configurations as we have not yet started to configure the mesh with additional _authorization_, _traffic_ or _resillience_ mesh configurations. Select instead *Istio Config -> Namespace (drop down) -> istio-system* and now you will see the default ones added by the mesh. Explore the *default* https://istio.io/latest/docs/reference/config/networking/destination-rule/[`DestinationRule`] (by clicking the link on the name of the configuration), as also shown by the animated guide below this configuration enforces *ISTIO_MUTUAL TLS* policy to all destinations with `*.cluster.local` service name suffix and this includes all the services you created in *_Module 1_*. If you wish you could change this policy here in `Kiali`, this would affect the encryption between components in the mesh (if you do please revert it before continuing).

image::07-t2-kiali-configs.gif[]

We shall explore https://istio.io/latest/docs/reference/config/networking/destination-rule/[`DestinationRule`] and additional mesh configurations more extensively  in the next module.


NOTE: Take a moment to pause and reflect on what has happened! The change of annotating the `VirtualMachine` OpenShift resource with `sidecar.istio.io/inject` has achieved all this. The Virtual Machines did not get altered but you are already getting a whole new experience. 

Lets now look back in the `Jaeger` Tracing console which now contains traces of the requests. From the services menu select the *travels-vm.portal* and click *Find Traces*. By default you will receive the last _20 Traces_ captured in the _last hour_ but you can increase that up to _1500 Traces_ as well as configure the time this was captured at from the menu. The console displays a top-level overview of:

* the requests in/out of the Virtual Machine (each _dot_ in the graph and each *Trace* line entry below represent a request passing through the *travels-vm.portal*)
* showing both successful and failed traced requests (a _blue dot_ indicates a successful request, a _red dot_ a failed one)
* the services the request traverses, (The *Trace* line entry identifies the services this request has traversed, spans created and total request time)
* overall time of the trace.

*Click* now on one *Trace line*, it will give you additional information on each individual step (span):

* success or failure HTTP code (HTTP 200 vs HTTP 500),
* the time elapsed.

The animated icon showcases reviewing successful and failed requests.

image::09-t2-jaeger-tracing.gif[]



Finally, in the `Grafana dashboard` of _Istio Mesh Dashboard_ you now have populated information about the solution that you can use to undertand the healthiness, content and usage of the solution.

image::10-t2-grafana-mesh-dashboard-with-data.png[Istio Mesh Dashboard]


*Congratulations for making through all the steps!!!* That was a lot of information and they are at the operator's fingertips with one simple annotation insertion.


## Task 4: Validate that the _Travel Agency_ Virtual Machines are part of the mesh

Final step, *test the _Travel Agency_* solution is operational. 

Access the _Travel Agency_ dashboard https://travel-dashboard-travel-control.apps.cluster-szndb.dynamic.redhatworkshops.io/. *Challenge: Why is the dashboard not accessible?*

TIP: You will need to https://docs.redhat.com/en/documentation/openshift_container_platform/4.18/html-single/service_mesh/index#ossm-routing-ingress_traffic-management[configure the mesh which included services are allowed to be exposed]. We will perform this in the next module.

Since, the user interface is not accessible verify the solution through service-to-service communications (always though intercepted by the mesh). Request for a travel quote from `travels` in the travel-portal to `travels-vm` in the 'travel-agency' namespace:

[,sh,subs="attributes",role=execute]
----
oc -n travel-portal exec $(oc -n travel-portal get po -l app=travels|awk '{print $1}'|tail -n 1) -- curl -s travels-vm.travel-agency.svc.cluster.local:8000/travels/London |jq
----

You should receive a quote similar to the one following:

[source,yaml,subs=attributes]
----
{
  "city": "London",
  "coordinates": null,
  "createdAt": "2025-03-24T13:58:06Z",
  "status": "Valid",
  "flights": [
    {
      "airline": "Red Airlines",
      "price": 1018
    },
    {
      "airline": "Blue Airlines",
      "price": 368
    },
    {
      "airline": "Green Airlines",
      "price": 318
    }
  ],
  "hotels": [
    {
      "hotel": "Grand Hotel London",
      "price": 590
    },
    {
      "hotel": "Little London Hotel",
      "price": 116
    }
  ],
  "cars": [
    {
      "carModel": "Sports Car",
      "price": 1090
    },
    {
      "carModel": "Economy Car",
      "price": 336
    }
  ],
  "insurances": [
    {
      "company": "Yellow Insurances",
      "price": 325
    },
    {
      "company": "Blue Insurances",
      "price": 74
    }
  ]
}
----


## Congratulations

In this module you have introduced the _Travel Agency_ namespaces, containers and Virtual Machines to service mesh, reviewed all the observability tooling on offer from OpenShift Service Mesh and by now have an understanding of how sidecars configure cross-cutting features of security, traffic and monitoring without altering the internal application components whether these are VMs or containers. The ease with which mesh has offered this is the most appealing aspect of all.